#!/usr/bin/env bash
set -e

# このスクリプトはBrewfileやglobal-packages.jsonが変更されたときに
# パッケージを更新するためのスクリプトです
# hash: {{ include "dot_Brewfile" | sha256sum }}
# hash: {{ include "dot_config/npm/global-packages.json" | sha256sum }}

echo "=== Updating system packages ==="

# Homebrewのパスを設定
if [ -f "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [ -f "/usr/local/bin/brew" ]; then
    eval "$(/usr/local/bin/brew shellenv)"
elif [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

# aqua用のパスを設定（まだ設定されていない場合のみ）
if [[ ":$PATH:" != *":$HOME/.local/share/aquaproj-aqua/bin:"* ]]; then
    export PATH="$HOME/.local/share/aquaproj-aqua/bin:$PATH"
fi

# Homebrewの更新
if command -v brew &> /dev/null; then
    echo "Updating Homebrew..."
    brew update
    
    echo "Upgrading Homebrew packages..."
    brew upgrade
    
    echo "Installing new packages from Brewfile..."
    if [ -f "$HOME/.Brewfile" ]; then
        brew bundle --global
    fi
    
    echo "Cleaning up old versions..."
    brew cleanup
fi

# NPMグローバルパッケージの更新
if command -v npm &> /dev/null; then
    echo ""
    echo "Updating NPM global packages..."
    npm update -g
fi

# Aquaパッケージの更新
if command -v aqua &> /dev/null; then
    # aqua.yamlが存在する場合のみ実行
    if [ -f "$HOME/.config/aqua/aqua.yaml" ] || [ -f "$AQUA_CONFIG" ]; then
        echo ""
        echo "Updating Aqua packages..."
        aqua update
    else
        echo ""
        echo "⚠️  Aqua is installed but no configuration file found. Skipping aqua update."
    fi
fi

echo ""
echo "✓ All packages updated!"