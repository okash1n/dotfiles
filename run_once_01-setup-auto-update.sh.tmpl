#!/usr/bin/env bash
set -e

# このスクリプトは定期的な自動更新を設定します
# cronを使用してchezmoiの更新を定期的に実行

echo "=== Setting up automatic updates ==="

# cronがインストールされているか確認
if ! command -v crontab &> /dev/null; then
    echo "⚠️  cron is not installed."
    
    {{ if eq .chezmoi.os "darwin" -}}
    # macOSでcronが無効の場合の対処
    echo "   On macOS, cron may be disabled. You can enable it or use launchd instead."
    echo "   To use cron, grant full disk access to /usr/sbin/cron in System Settings."
    {{- else if eq .chezmoi.os "linux" -}}
    # Linuxでcronをインストール
    echo "   Installing cron..."
    if command -v apt-get &> /dev/null; then
        sudo apt-get update && sudo apt-get install -y cron
    elif command -v yum &> /dev/null; then
        sudo yum install -y cronie
    else
        echo "⚠️  Could not install cron. Please install it manually."
        echo "   You can set up automatic updates later by adding this to your crontab:"
        echo "   0 12 * * * $(which chezmoi) update --apply >> /tmp/chezmoi-update.log 2>&1"
        exit 0
    fi
    {{- end }}
fi

# Homebrewのパスを検出
BREW_PREFIX=""
if [ -f "/opt/homebrew/bin/brew" ]; then
    BREW_PREFIX="/opt/homebrew"
elif [ -f "/usr/local/bin/brew" ]; then
    BREW_PREFIX="/usr/local"
elif [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    BREW_PREFIX="/home/linuxbrew/.linuxbrew"
elif [ -f "$HOME/.linuxbrew/bin/brew" ]; then
    BREW_PREFIX="$HOME/.linuxbrew"
fi

# chezmoiのフルパスを取得
CHEZMOI_PATH="$(which chezmoi 2>/dev/null || echo "$BREW_PREFIX/bin/chezmoi")"

# 既存のchezmoi更新エントリを削除
crontab -l 2>/dev/null | grep -v "chezmoi update" | crontab - 2>/dev/null || true

# 新しいcronエントリを追加
(crontab -l 2>/dev/null || true; echo "0 12 * * * PATH=$BREW_PREFIX/bin:/usr/local/bin:/usr/bin:/bin $CHEZMOI_PATH update --apply >> /tmp/chezmoi-update.log 2>&1") | crontab -

echo "✓ Automatic daily updates configured using cron"
echo "  Updates will run daily at 12:00 PM"
echo "  Logs: /tmp/chezmoi-update.log"
echo ""
echo "To disable automatic updates:"
echo "  crontab -e # and remove the chezmoi update line"
echo ""
echo "To view current cron jobs:"
echo "  crontab -l"

{{ if eq .chezmoi.os "darwin" -}}
# macOSで既存のlaunchd設定があれば削除（cron移行のため）
if [ -f "$HOME/Library/LaunchAgents/com.chezmoi.update.plist" ]; then
    echo "Removing old launchd configuration..."
    launchctl unload "$HOME/Library/LaunchAgents/com.chezmoi.update.plist" 2>/dev/null || true
    rm -f "$HOME/Library/LaunchAgents/com.chezmoi.update.plist"
fi
{{- end }}